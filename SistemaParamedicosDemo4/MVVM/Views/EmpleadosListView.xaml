<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="SistemaParamedicosDemo4.MVVM.Views.EmpleadosListView"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:SistemaParamedicosDemo4.MVVM.ViewModels"
             xmlns:behaviors="clr-namespace:SistemaParamedicosDemo4.Behaviors"
             Title="Lista de Empleados"
             BackgroundColor="#F5F7FA">

    <ContentPage.Behaviors>
        <behaviors:PageAppearingBehavior Command="{Binding AppearingCommand}"/>
    </ContentPage.Behaviors>

    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="PrimaryColor">#2E86AB</Color>
            <Color x:Key="DarkGray">#343A40</Color>
            <Color x:Key="MediumGray">#6C757D</Color>
            <Color x:Key="LightGray">#F8F9FA</Color>
            <Color x:Key="BorderColor">#DEE2E6</Color>
            <Color x:Key="SuccessColor">#28A745</Color>

            <Style x:Key="HeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="24"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="{StaticResource DarkGray}"/>
            </Style>

            <Style x:Key="SearchBarStyle" TargetType="SearchBar">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="TextColor" Value="{StaticResource DarkGray}"/>
                <Setter Property="PlaceholderColor" Value="{StaticResource MediumGray}"/>
                <Setter Property="CancelButtonColor" Value="{StaticResource PrimaryColor}"/>
            </Style>

            <Style x:Key="CardStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="StrokeThickness" Value="1"/>
                <Setter Property="Stroke" Value="{StaticResource BorderColor}"/>
                <Setter Property="StrokeShape" Value="RoundRectangle 12"/>
                <Setter Property="Padding" Value="15"/>
                <Setter Property="Margin" Value="10,5"/>
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="Gray" Opacity="0.1" Radius="8" Offset="0,2"/>
                    </Setter.Value>
                </Setter>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackLayout Grid.Row="0" Margin="0,0,0,20">
            <Label Text="Lista de Empleados" Style="{StaticResource HeaderStyle}"/>
            <Label Text="{Binding TotalEmpleados, StringFormat='Total: {0} empleados'}"
                   TextColor="{StaticResource MediumGray}"
                   FontSize="14"/>
        </StackLayout>

        <!-- â­ INDICADOR DE SINCRONIZACIÃ“N -->
        <Border Grid.Row="1"
                BackgroundColor="#E3F2FD"
                StrokeThickness="0"
                StrokeShape="RoundRectangle 8"
                Padding="12,8"
                Margin="0,0,0,10"
                IsVisible="{Binding IsBusy}">
            <HorizontalStackLayout Spacing="10">
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   Color="{StaticResource PrimaryColor}"
                                   WidthRequest="20"
                                   HeightRequest="20"/>
                <Label Text="{Binding MensajeEstado}"
                       FontSize="13"
                       TextColor="{StaticResource PrimaryColor}"
                       VerticalOptions="Center"/>
            </HorizontalStackLayout>
        </Border>

        <!-- Mensaje de estado (cuando no estÃ¡ cargando) -->
        <Label Grid.Row="1"
               Text="{Binding MensajeEstado}"
               FontSize="12"
               TextColor="{StaticResource SuccessColor}"
               HorizontalOptions="Center"
               Margin="0,0,0,10"
               IsVisible="{Binding MensajeEstado}">
            <Label.Triggers>
                <DataTrigger TargetType="Label" Binding="{Binding IsBusy}" Value="True">
                    <Setter Property="IsVisible" Value="False"/>
                </DataTrigger>
            </Label.Triggers>
        </Label>

        <!-- Barra de bÃºsqueda -->
        <SearchBar Grid.Row="2"
                   Placeholder="Buscar por nombre, ID o puesto..."
                   Text="{Binding TextoBusqueda}"
                   SearchCommand="{Binding BuscarCommand}"
                   Style="{StaticResource SearchBarStyle}"
                   Margin="0,0,0,10"/>

        <!-- Filtros rÃ¡pidos -->
        <HorizontalStackLayout Grid.Row="3" Spacing="10" Margin="0,0,0,15">
            <Button Text="Todos"
                    Command="{Binding MostrarTodosCommand}"
                    BackgroundColor="{StaticResource PrimaryColor}"
                    TextColor="White"
                    CornerRadius="6"
                    Padding="15,8"
                    FontSize="12"/>

            <Button Text="Choferes"
                    Command="{Binding FiltrarPorPuestoCommand}"
                    CommandParameter="CHOFER"
                    BackgroundColor="{StaticResource LightGray}"
                    TextColor="{StaticResource DarkGray}"
                    CornerRadius="6"
                    Padding="15,8"
                    FontSize="12"/>

            <Button Text="Operadores"
                    Command="{Binding FiltrarPorPuestoCommand}"
                    CommandParameter="OPERADOR"
                    BackgroundColor="{StaticResource LightGray}"
                    TextColor="{StaticResource DarkGray}"
                    CornerRadius="6"
                    Padding="15,8"
                    FontSize="12"/>
        </HorizontalStackLayout>

        <!-- Lista de empleados -->
        <CollectionView Grid.Row="4"
                        ItemsSource="{Binding EmpleadosFiltrados}"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <StackLayout Padding="50" VerticalOptions="Center">
                    <Label Text="ðŸ˜”"
                           FontSize="48"
                           HorizontalOptions="Center"/>
                    <Label Text="No se encontraron empleados"
                           FontSize="18"
                           TextColor="{StaticResource MediumGray}"
                           HorizontalOptions="Center"
                           Margin="0,10,0,0"/>
                </StackLayout>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Border Style="{StaticResource CardStyle}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:EmpleadosListViewModel}}, Path=VerHistorialCommand}"
                                CommandParameter="{Binding .}"/>
                        </Border.GestureRecognizers>

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="60"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Avatar -->
                            <Border Grid.Column="0"
                                    BackgroundColor="{StaticResource PrimaryColor}"
                                    StrokeThickness="0"
                                    StrokeShape="RoundRectangle 25"
                                    WidthRequest="50"
                                    HeightRequest="50">
                                <Label Text="{Binding Iniciales}"
                                       TextColor="White"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Border>

                            <!-- InformaciÃ³n -->
                            <StackLayout Grid.Column="1" Spacing="4" Margin="15,0,0,0">
                                <Label Text="{Binding Nombre}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource DarkGray}"/>
                                <HorizontalStackLayout Spacing="8">
                                    <Label Text="{Binding NombrePuesto}"
                                           FontSize="12"
                                           TextColor="{StaticResource MediumGray}"/>
                                    <Label Text="â€¢"
                                           FontSize="12"
                                           TextColor="{StaticResource MediumGray}"/>
                                    <Label Text="{Binding TotalConsultas, StringFormat='{0} consultas'}"
                                           FontSize="12"
                                           TextColor="{StaticResource PrimaryColor}"
                                           FontAttributes="Bold"/>
                                </HorizontalStackLayout>
                            </StackLayout>

                            <!-- Flecha -->
                            <Label Grid.Column="2"
                                   Text="â€º"
                                   FontSize="32"
                                   TextColor="{StaticResource MediumGray}"
                                   VerticalOptions="Center"/>
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>