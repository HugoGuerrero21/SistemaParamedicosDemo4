<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="SistemaParamedicosDemo4.MVVM.Views.TraspasoView"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:SistemaParamedicosDemo4.MVVM.ViewModels"
             Title="RecepciÃ³n de Traspasos"
             BackgroundColor="#F5F7FA">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Colores -->
            <Color x:Key="PrimaryColor">#2E86AB</Color>
            <Color x:Key="SecondaryColor">#17A2B8</Color>
            <Color x:Key="SuccessColor">#28A745</Color>
            <Color x:Key="DangerColor">#DC3545</Color>
            <Color x:Key="WarningColor">#FFC107</Color>
            <Color x:Key="LightGray">#F8F9FA</Color>
            <Color x:Key="MediumGray">#6C757D</Color>
            <Color x:Key="DarkGray">#343A40</Color>
            <Color x:Key="BorderColor">#DEE2E6</Color>

            <!-- Estilos -->
            <Style x:Key="CardStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="White"/>
                <Setter Property="StrokeThickness" Value="1"/>
                <Setter Property="Stroke" Value="{StaticResource BorderColor}"/>
                <Setter Property="StrokeShape" Value="RoundRectangle 8"/>
                <Setter Property="Padding" Value="15"/>
                <Setter Property="Margin" Value="5"/>
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="Gray" Opacity="0.15" Radius="6" Offset="0,2"/>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="HeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="24"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="{StaticResource DarkGray}"/>
                <Setter Property="Margin" Value="0,0,0,5"/>
            </Style>

            <Style x:Key="SubHeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="{StaticResource DarkGray}"/>
            </Style>

            <Style x:Key="BodyStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="{StaticResource MediumGray}"/>
            </Style>

            <Style x:Key="FieldLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="13"/>
                <Setter Property="TextColor" Value="{StaticResource DarkGray}"/>
                <Setter Property="Margin" Value="0,0,0,5"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <ScrollView>
            <StackLayout Padding="20">

                <!-- Header -->
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackLayout Grid.Column="0">
                        <Label Text="RecepciÃ³n de Traspasos" Style="{StaticResource HeaderStyle}"/>
                        <Label Text="GestiÃ³n de traspasos desde Hermosillo (ALM1) hacia ParamÃ©dicos (ALM6)" Style="{StaticResource BodyStyle}"/>
                    </StackLayout>

                    <!-- BotÃ³n Refrescar -->
                    <Button Grid.Column="1"
                            Text="ðŸ”„ Refrescar"
                            Command="{Binding RefrescarCommand}"
                            BackgroundColor="{StaticResource SecondaryColor}"
                            TextColor="White"
                            CornerRadius="8"
                            Padding="15,10"
                            FontSize="14"
                            VerticalOptions="Start"/>
                </Grid>

                <!-- Selector de Vista (Tabs) -->
                <Border BackgroundColor="White"
        StrokeThickness="1"
        Stroke="#DEE2E6"
        StrokeShape="RoundRectangle 10"
        Padding="5"
        Margin="0,0,0,15">
                    <Grid ColumnSpacing="5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Tab Pendientes -->
                        <Button Grid.Column="0"
                Text="ðŸ“¦ Pendientes"
                Command="{Binding CambiarVistaPendientesCommand}"
                BackgroundColor="{Binding ColorTabPendientes}"
                TextColor="{Binding ColorTextoTabPendientes}"
                CornerRadius="8"
                FontSize="14"
                FontAttributes="Bold"
                HeightRequest="45"/>

                        <!-- Tab Historial -->
                        <Button Grid.Column="1"
                Text="ðŸ“‹ Historial"
                Command="{Binding CambiarVistaHistorialCommand}"
                BackgroundColor="{Binding ColorTabHistorial}"
                TextColor="{Binding ColorTextoTabHistorial}"
                CornerRadius="8"
                FontSize="14"
                FontAttributes="Bold"
                HeightRequest="45"/>
                    </Grid>
                </Border>

                <!-- Tarjetas de EstadÃ­sticas -->
                <Grid ColumnSpacing="10" Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Total Traspasos -->
                    <Border Grid.Column="0"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="{StaticResource BorderColor}"
                            StrokeShape="RoundRectangle 12"
                            Padding="15,12">
                        <StackLayout Spacing="5">
                            <Label Text="ðŸ“¦"
                                   FontSize="28"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding TotalTraspasos}"
                                   FontSize="32"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryColor}"
                                   HorizontalOptions="Center"/>
                            <Label Text="Traspasos"
                                   FontSize="13"
                                   TextColor="{StaticResource MediumGray}"
                                   HorizontalOptions="Center"/>
                        </StackLayout>
                    </Border>

                    <!-- Productos Totales -->
                    <Border Grid.Column="1"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="{StaticResource PrimaryColor}"
                            StrokeShape="RoundRectangle 12"
                            Padding="15,12">
                        <StackLayout Spacing="5">
                            <Label Text="ðŸ“‹"
                                   FontSize="28"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding ProductosTotales}"
                                   FontSize="32"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource PrimaryColor}"
                                   HorizontalOptions="Center"/>
                            <Label Text="Productos"
                                   FontSize="13"
                                   TextColor="{StaticResource MediumGray}"
                                   HorizontalOptions="Center"/>
                        </StackLayout>
                    </Border>

                    <!-- Completados -->
                    <Border Grid.Column="2"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="{StaticResource SuccessColor}"
                            StrokeShape="RoundRectangle 12"
                            Padding="15,12">
                        <StackLayout Spacing="5">
                            <Label Text="âœ…"
                                   FontSize="28"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding ProductosCompletados}"
                                   FontSize="32"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource SuccessColor}"
                                   HorizontalOptions="Center"/>
                            <Label Text="Recibidos"
                                   FontSize="13"
                                   TextColor="{StaticResource MediumGray}"
                                   HorizontalOptions="Center"/>
                        </StackLayout>
                    </Border>

                    <!-- Pendientes -->
                    <Border Grid.Column="3"
                            BackgroundColor="White"
                            StrokeThickness="1"
                            Stroke="{StaticResource WarningColor}"
                            StrokeShape="RoundRectangle 12"
                            Padding="15,12">
                        <StackLayout Spacing="5">
                            <Label Text="â³"
                                   FontSize="28"
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding ProductosPendientes}"
                                   FontSize="32"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource WarningColor}"
                                   HorizontalOptions="Center"/>
                            <Label Text="Pendientes"
                                   FontSize="13"
                                   TextColor="{StaticResource MediumGray}"
                                   HorizontalOptions="Center"/>
                        </StackLayout>
                    </Border>
                </Grid>

                <!-- Mensaje de Estado -->
                <Label Text="{Binding MensajeEstado}"
                       Style="{StaticResource BodyStyle}"
                       FontSize="12"
                       HorizontalOptions="Center"
                       Margin="0,0,0,10"
                       IsVisible="{Binding MensajeEstado, Converter={StaticResource StringToBoolConverter}}"/>

                <!-- Indicador de Carga -->
                <ActivityIndicator IsRunning="{Binding IsCargando}"
                                   IsVisible="{Binding IsCargando}"
                                   Color="{StaticResource PrimaryColor}"
                                   Margin="0,10,0,10"/>

                <!-- Lista de Traspasos -->
                <CollectionView ItemsSource="{Binding TraspasosPendientes}"
                                SelectionMode="None">
                    <CollectionView.EmptyView>
                        <StackLayout Padding="50" VerticalOptions="Center">
                            <Label Text="ðŸ“¦"
                                   FontSize="48"
                                   HorizontalOptions="Center"/>
                            <Label Text="No hay traspasos pendientes"
                                   FontSize="18"
                                   TextColor="{StaticResource MediumGray}"
                                   HorizontalOptions="Center"
                                   Margin="0,10,0,0"/>
                            <Label Text="Los traspasos recibidos aparecerÃ¡n aquÃ­"
                                   FontSize="14"
                                   TextColor="{StaticResource MediumGray}"
                                   HorizontalOptions="Center"
                                   Margin="0,5,0,0"/>
                        </StackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border Style="{StaticResource CardStyle}" Padding="20" Margin="0,0,0,10">
                                <StackLayout>
                                    <!-- Header del Traspaso (Clickeable) -->
                                    <Grid>
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleDetalleCommand}"
                                                CommandParameter="{Binding .}"/>
                                        </Grid.GestureRecognizers>

                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Icono Expandir -->
                                        <Label Grid.Column="0"
                                               Text="{Binding IconoExpandir}"
                                               FontSize="20"
                                               TextColor="{StaticResource PrimaryColor}"
                                               VerticalOptions="Center"
                                               Margin="0,0,15,0"/>

                                        <!-- Info del Traspaso -->
                                        <StackLayout Grid.Column="1" Spacing="6">
                                            <Label Text="{Binding IdTraspaso, StringFormat='Traspaso: {0}'}"
                                                   Style="{StaticResource SubHeaderStyle}"
                                                   FontSize="18"/>

                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <!-- AlmacÃ©n Origen -->
                                                <Label Grid.Row="0" Grid.Column="0"
                                                       Text="AlmacÃ©n Origen:"
                                                       Style="{StaticResource FieldLabelStyle}"
                                                       FontSize="12"
                                                       VerticalOptions="Center"
                                                       Margin="0,0,10,0"/>
                                                <Label Grid.Row="0" Grid.Column="1"
                                                       Text="{Binding NombreAlmacenOrigen}"
                                                       Style="{StaticResource BodyStyle}"
                                                       FontSize="12"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>

                                                <!-- AlmacÃ©n Destino -->
                                                <Label Grid.Row="1" Grid.Column="0"
                                                       Text="AlmacÃ©n Destino:"
                                                       Style="{StaticResource FieldLabelStyle}"
                                                       FontSize="12"
                                                       VerticalOptions="Center"
                                                       Margin="0,0,10,0"/>
                                                <Label Grid.Row="1" Grid.Column="1"
                                                       Text="{Binding NombreAlmacenDestino}"
                                                       Style="{StaticResource BodyStyle}"
                                                       FontSize="12"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>

                                                <!-- Chofer -->
                                                <Label Grid.Row="2" Grid.Column="0"
                                                       Text="Chofer:"
                                                       Style="{StaticResource FieldLabelStyle}"
                                                       FontSize="12"
                                                       VerticalOptions="Center"
                                                       Margin="0,0,10,0"/>
                                                <Label Grid.Row="2" Grid.Column="1"
                                                       Text="{Binding NombreChofer}"
                                                       Style="{StaticResource BodyStyle}"
                                                       FontSize="12"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>

                                                <!-- Unidad -->
                                                <Label Grid.Row="3" Grid.Column="0"
                                                       Text="Unidad:"
                                                       Style="{StaticResource FieldLabelStyle}"
                                                       FontSize="12"
                                                       VerticalOptions="Center"
                                                       Margin="0,0,10,0"/>
                                                <Label Grid.Row="3" Grid.Column="1"
                                                       Text="{Binding NoEconomico}"
                                                       Style="{StaticResource BodyStyle}"
                                                       FontSize="12"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>

                                                <!-- Fecha de EnvÃ­o -->
                                                <Label Grid.Row="4" Grid.Column="0"
                                                       Text="Fecha EnvÃ­o:"
                                                       Style="{StaticResource FieldLabelStyle}"
                                                       FontSize="12"
                                                       VerticalOptions="Center"
                                                       Margin="0,0,10,0"/>
                                                <Label Grid.Row="4" Grid.Column="1"
                                                       Text="{Binding FechaEnvioFormateada}"
                                                       Style="{StaticResource BodyStyle}"
                                                       FontSize="12"
                                                       VerticalOptions="Center"/>

                                                <!-- Progreso -->
                                                <Label Grid.Row="5" Grid.Column="0"
                                                       Text="Progreso:"
                                                       Style="{StaticResource FieldLabelStyle}"
                                                       FontSize="12"
                                                       VerticalOptions="Center"
                                                       Margin="0,0,10,0"/>
                                                <Label Grid.Row="5" Grid.Column="1"
                                                       Text="{Binding ProgresoTexto}"
                                                       Style="{StaticResource BodyStyle}"
                                                       FontSize="12"
                                                       TextColor="{StaticResource SuccessColor}"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </StackLayout>

                                        <!-- Badge de Estado -->
                                        <Border Grid.Column="2"
                                                BackgroundColor="{Binding ColorStatus}"
                                                StrokeThickness="0"
                                                StrokeShape="RoundRectangle 12"
                                                Padding="12,6"
                                                VerticalOptions="Start">
                                            <Label Text="{Binding StatusTexto}"
                                                   TextColor="White"
                                                   FontSize="12"
                                                   FontAttributes="Bold"/>
                                        </Border>
                                    </Grid>

                                    <!-- Detalles del Traspaso (Expandible) -->
                                    <StackLayout IsVisible="{Binding Expandido}" Margin="0,20,0,0">

                                        <!-- Lista de Productos (Tabla) -->
                                        <!-- â­ TABLA DE PRODUCTOS CORREGIDA -->
                                        <Border BackgroundColor="#F8F9FA"
        StrokeThickness="1"
        Stroke="#DEE2E6"
        StrokeShape="RoundRectangle 8"
        Padding="0">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <!-- Header -->
                                                    <RowDefinition Height="Auto"/>
                                                    <!-- Items -->
                                                </Grid.RowDefinitions>

                                                <!-- â­ HEADER DE LA TABLA -->
                                                <Grid Grid.Row="0" 
              BackgroundColor="#343A40"
              Padding="12,10">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="120"/>
                                                        <!-- Clave Producto -->
                                                        <ColumnDefinition Width="2*"/>
                                                        <!-- Nombre Producto -->
                                                        <ColumnDefinition Width="90"/>
                                                        <!-- Solicitada -->
                                                        <ColumnDefinition Width="90"/>
                                                        <!-- Recibida -->
                                                        <ColumnDefinition Width="90"/>
                                                        <!-- Faltante -->
                                                        <ColumnDefinition Width="120"/>
                                                        <!-- Estado -->
                                                        <ColumnDefinition Width="100"/>
                                                        <!-- AcciÃ³n -->
                                                    </Grid.ColumnDefinitions>

                                                    <Label Grid.Column="0" Text="Clave" 
                   TextColor="White" FontSize="12" FontAttributes="Bold" 
                   VerticalOptions="Center"/>
                                                    <Label Grid.Column="1" Text="Producto" 
                   TextColor="White" FontSize="12" FontAttributes="Bold" 
                   VerticalOptions="Center"/>
                                                    <Label Grid.Column="2" Text="Solicitada" 
                   TextColor="White" FontSize="12" FontAttributes="Bold" 
                   HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    <Label Grid.Column="3" Text="Recibida" 
                   TextColor="White" FontSize="12" FontAttributes="Bold" 
                   HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    <Label Grid.Column="4" Text="Faltante" 
                   TextColor="White" FontSize="12" FontAttributes="Bold" 
                   HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    <Label Grid.Column="5" Text="Estado" 
                   TextColor="White" FontSize="12" FontAttributes="Bold" 
                   HorizontalOptions="Center" VerticalOptions="Center"/>
                                                    <Label Grid.Column="6" Text="AcciÃ³n" 
                   TextColor="White" FontSize="12" FontAttributes="Bold" 
                   HorizontalOptions="Center" VerticalOptions="Center"/>
                                                </Grid>

                                                <!-- â­ ITEMS DE LA TABLA -->
                                                <CollectionView Grid.Row="1"
                        ItemsSource="{Binding Detalles}"
                        SelectionMode="None">
                                                    <CollectionView.ItemTemplate>
                                                        <DataTemplate>
                                                            <Grid BackgroundColor="White"
                          Padding="12,15">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="120"/>
                                                                    <ColumnDefinition Width="2*"/>
                                                                    <ColumnDefinition Width="90"/>
                                                                    <ColumnDefinition Width="90"/>
                                                                    <ColumnDefinition Width="90"/>
                                                                    <ColumnDefinition Width="120"/>
                                                                    <ColumnDefinition Width="100"/>
                                                                </Grid.ColumnDefinitions>

                                                                <!-- Clave Producto -->
                                                                <Label Grid.Column="0"
                               Text="{Binding IdProducto}"
                               FontSize="12"
                               TextColor="#343A40"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               LineBreakMode="TailTruncation"/>

                                                                <!-- Nombre Producto -->
                                                                <Label Grid.Column="1"
                               Text="{Binding NombreCompletoProducto}"
                               FontSize="12"
                               TextColor="#343A40"
                               VerticalOptions="Center"
                               LineBreakMode="WordWrap"
                               MaxLines="2"
                               Margin="5,0"/>

                                                                <!-- Solicitada -->
                                                                <Label Grid.Column="2"
                               Text="{Binding Cantidad, StringFormat='{0:F0}'}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="#343A40"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>

                                                                <!-- Recibida -->
                                                                <Label Grid.Column="3"
                               Text="{Binding CantidadRecibida, StringFormat='{0:F0}'}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="#28A745"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>

                                                                <!-- Faltante -->
                                                                <Label Grid.Column="4"
                               Text="{Binding CantidadFaltante, StringFormat='{0:F0}'}"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="#FFC107"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"/>

                                                                <!-- Estado -->
                                                                <Border Grid.Column="5"
                                BackgroundColor="{Binding ColorEstado}"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 12"
                                Padding="10,6"
                                HorizontalOptions="Center"
                                VerticalOptions="Center">
                                                                    <Label Text="{Binding TextoEstado}"
                                   TextColor="White"
                                   FontSize="11"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                                                                </Border>

                                                                <!-- AcciÃ³n (Botones âœ“ y âœ•) -->
                                                                <HorizontalStackLayout Grid.Column="6"
                                               Spacing="8"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               IsVisible="{Binding MostrarBotonesAccion}">

                                                                    <!-- BotÃ³n Check (SÃ­ llegÃ³ TODO) -->
                                                                    <Button Text="âœ“"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ConfirmarRecepcionCommand}"
                                    CommandParameter="{Binding .}"
                                    BackgroundColor="#28A745"
                                    TextColor="White"
                                    CornerRadius="8"
                                    WidthRequest="38"
                                    HeightRequest="38"
                                    FontSize="18"
                                    FontAttributes="Bold"
                                    Padding="0"
                                    VerticalOptions="Center"/>

                                                                    <!-- BotÃ³n X (No llegÃ³ NADA) -->
                                                                    <Button Text="âœ•"
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RechazarRecepcionCommand}"
                                    CommandParameter="{Binding .}"
                                    BackgroundColor="#DC3545"
                                    TextColor="White"
                                    CornerRadius="8"
                                    WidthRequest="38"
                                    HeightRequest="38"
                                    FontSize="18"
                                    FontAttributes="Bold"
                                    Padding="0"
                                    VerticalOptions="Center"/>
                                                                </HorizontalStackLayout>

                                                            </Grid>
                                                        </DataTemplate>
                                                    </CollectionView.ItemTemplate>
                                                </CollectionView>
                                            </Grid>
                                        </Border>

                                    </StackLayout>

                                </StackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </StackLayout>
        </ScrollView>
    </Grid>
</ContentPage>